"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const i=require("electron"),w=require("node:path"),g=require("node:fs"),R=require("sqlite3"),S=require("path");function M(r){const e=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(r){for(const n in r)if(n!=="default"){const t=Object.getOwnPropertyDescriptor(r,n);Object.defineProperty(e,n,t.get?t:{enumerable:!0,get:()=>r[n]})}}return e.default=r,Object.freeze(e)}const _=M(S),I=_.join(i.app.getPath("userData"),"markdown.db"),c=new R.Database(I);function D(){c.exec(`
    CREATE TABLE IF NOT EXISTS markdowns (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      title TEXT NOT NULL,
      content TEXT NOT NULL,
      created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
      updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );
  `)}function m(){return new Promise((r,e)=>{c.all("SELECT * FROM markdowns ORDER BY updated_at DESC",(n,t)=>{if(n)console.error("getAllMarkdowns error:",n),e(n);else{console.log("getAllMarkdowns found:",t.length,"documents"),t.forEach(o=>{var a;console.log("  - doc id:",o.id,"title:",o.title,"content length:",(a=o.content)==null?void 0:a.length)});const s=t.map(o=>({...o}));r(s)}})})}function T(r){return new Promise((e,n)=>{c.get("SELECT * FROM markdowns WHERE id = ?",[r],(t,s)=>{if(t)n(t);else if(s){const o={...s};e(o)}else e(void 0)})})}function P(r,e){return new Promise((n,t)=>{const s=typeof e=="string"?e:e!=null?JSON.stringify(e):"";console.log("Creating markdown with content:",s),c.run("INSERT INTO markdowns (title, content) VALUES (?, ?)",[r,s],function(o){o?t(o):c.get("SELECT * FROM markdowns WHERE id = ?",[this.lastID],(a,d)=>{if(a)t(a);else if(d){const E={...d};n(E)}else t(new Error("Failed to retrieve created markdown"))})})})}function O(r,e,n){return new Promise((t,s)=>{console.log("updateMarkdown called with:",{id:r,title:e,contentType:typeof n,content:n});const o=typeof n=="string"?n:n!=null?JSON.stringify(n):"";console.log("Updating markdown with content length:",o.length),c.run("UPDATE markdowns SET title = ?, content = ?, updated_at = CURRENT_TIMESTAMP WHERE id = ?",[e,o,r],function(a){a?(console.error("Update error:",a),s(a)):(console.log("Update successful, changes:",this.changes),c.get("SELECT * FROM markdowns WHERE id = ?",[r],(d,E)=>{if(d)s(d);else if(E){const k={...E};t(k)}else t(void 0)}))})})}function y(r){return new Promise((e,n)=>{c.run("DELETE FROM markdowns WHERE id = ?",[r],function(t){t?n(t):e(this.changes>0)})})}const u=process.cwd();process.env.APP_ROOT=u;const p=process.env.VITE_DEV_SERVER_URL,N=w.join(u,"dist-electron"),f=w.join(u,"dist");process.env.VITE_PUBLIC=p?w.join(u,"public"):f;let l;function h(){l=new i.BrowserWindow({icon:w.join(process.env.VITE_PUBLIC,"electron-vite.svg"),webPreferences:{preload:w.join(u,"dist-electron","preload.cjs")}}),l.webContents.on("did-finish-load",()=>{l==null||l.webContents.send("main-process-message",new Date().toLocaleString())}),p?(l.loadURL(p),l.webContents.openDevTools()):l.loadFile(w.join(f,"index.html"))}i.app.on("window-all-closed",()=>{process.platform!=="darwin"&&(i.app.quit(),l=null)});i.app.on("activate",()=>{i.BrowserWindow.getAllWindows().length===0&&h()});i.app.whenReady().then(()=>{D(),h()});i.ipcMain.handle("get-all-markdowns",()=>m());i.ipcMain.handle("get-markdown-by-id",(r,e)=>T(e));i.ipcMain.handle("create-markdown",(r,e)=>(console.log("IPC create-markdown received:",e),P(e.title,e.content)));i.ipcMain.handle("update-markdown",(r,e)=>(console.log("IPC update-markdown received:",e),O(e.id,e.title,e.content)));i.ipcMain.handle("delete-markdown",(r,e)=>y(e));i.ipcMain.handle("export-markdown",async(r,{id:e,fileName:n})=>{const t=await T(e);if(!t)throw new Error(`Markdown with ID ${e} not found`);const{canceled:s,filePath:o}=await i.dialog.showSaveDialog(l,{defaultPath:n||`markdown-${e}.json`,filters:[{name:"JSON Files",extensions:["json"]},{name:"All Files",extensions:["*"]}]});if(s||!o)return{success:!1,message:"Save dialog canceled"};try{const a=typeof t.content=="string"?t.content:JSON.stringify(t.content),d={...t,content:a};return g.writeFileSync(o,JSON.stringify(d,null,2),"utf8"),{success:!0,filePath:o}}catch(a){throw console.error("Failed to export markdown:",a),new Error(`Failed to export markdown: ${a.message}`)}});i.ipcMain.handle("export-all-markdowns",async(r,{fileName:e})=>{const n=await m(),{canceled:t,filePath:s}=await i.dialog.showSaveDialog(l,{defaultPath:e||"all-markdowns.json",filters:[{name:"JSON Files",extensions:["json"]},{name:"All Files",extensions:["*"]}]});if(t||!s)return{success:!1,message:"Save dialog canceled"};try{const o=n.map(a=>({...a,content:typeof a.content=="string"?a.content:JSON.stringify(a.content)}));return g.writeFileSync(s,JSON.stringify(o,null,2),"utf8"),{success:!0,filePath:s,count:n.length}}catch(o){throw console.error("Failed to export all markdowns:",o),new Error(`Failed to export all markdowns: ${o instanceof Error?o.message:String(o)}`)}});exports.MAIN_DIST=N;exports.RENDERER_DIST=f;exports.VITE_DEV_SERVER_URL=p;
